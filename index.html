<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Configuration Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: #1f2937; }
        .enterprise-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .enterprise-input { border: 1px solid #d1d5db; transition: all 0.2s; }
        .enterprise-input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .nav-link.active { border-bottom: 2px solid var(--primary-color); color: var(--primary-color); font-weight: 600; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-secondary { background-color: #fff; border: 1px solid #d1d5db; }
        .btn-secondary:hover { background-color: #f9fafb; }
        .output-area { font-family: 'Fira Code', monospace; background-color: #1f2937; color: #f3f4f6; }

        /* Device List Item */
        .device-item { cursor: pointer; transition: all 0.2s; }
        .device-item:hover { background-color: #eff6ff; }
        .device-item.active { background-color: #dbeafe; border-right: 3px solid var(--primary-color); }

        /* Validation Error */
        .validation-error { color: #dc2626; font-size: 0.75rem; margin-top: 0.25rem; font-weight: 500; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shrink-0 z-10">
        <div>
            <h1 class="text-xl font-bold text-gray-900">Network Configuration Manager</h1>
            <p class="text-xs text-gray-500">Topology Designer & Config Generator</p>
        </div>
        <div class="flex space-x-2">
            <button class="px-3 py-1.5 text-sm font-medium rounded-md bg-blue-50 text-blue-700 hover:bg-blue-100" onclick="addDevice('router')">+ Add Router</button>
            <button class="px-3 py-1.5 text-sm font-medium rounded-md bg-purple-50 text-purple-700 hover:bg-purple-100" onclick="addDevice('switch')">+ Add Switch</button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden">

        <!-- Sidebar: Device List -->
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col shrink-0 overflow-y-auto">
            <div class="p-4 border-b border-gray-100">
                <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Topology Devices</h2>
            </div>
            <div id="device-list" class="flex-1">
                <!-- Devices rendered here -->
            </div>
        </aside>

        <!-- Main Content: Configuration -->
        <main class="flex-1 overflow-y-auto p-8 bg-gray-50">
            <div id="config-panel" class="max-w-5xl mx-auto hidden">

                <!-- Device Header -->
                <div class="flex justify-between items-center mb-6">
                    <h2 id="active-device-title" class="text-2xl font-bold text-gray-800">Router Configuration</h2>
                    <button onclick="deleteActiveDevice()" class="text-red-600 hover:text-red-800 text-sm font-medium">Delete Device</button>
                </div>

                <!-- Global Settings Card -->
                <div class="enterprise-card p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-100">Global Settings</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Hostname</label>
                            <input type="text" id="dev-hostname" class="w-full p-2 rounded enterprise-input" oninput="updateHostname(this.value)">
                        </div>
                        <div class="space-y-3 pt-4">
                            <!-- Router Specific Globals -->
                            <div id="router-globals" class="hidden">
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="dev-mpls" onchange="updateGlobalSetting('mpls', this.checked)">
                                    <label class="text-sm text-gray-700">Enable MPLS (Global)</label>
                                </div>
                                <div class="mt-2">
                                    <label class="block text-xs font-medium text-gray-600">BGP AS Number</label>
                                    <input type="number" id="dev-bgp-as" class="w-full p-2 mt-1 rounded enterprise-input text-sm" placeholder="e.g. 65000" oninput="updateGlobalSetting('bgpAs', this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Interfaces Section -->
                <h3 class="text-lg font-bold text-gray-800 mb-4">Interfaces</h3>
                <div id="interface-list" class="space-y-4 mb-6">
                    <!-- Dynamic Interfaces -->
                </div>

                <div class="flex justify-center mb-8">
                    <button onclick="addInterface()" class="btn-secondary px-4 py-2 rounded-md shadow-sm text-sm font-medium flex items-center gap-2">
                        <span>+ Add Interface</span>
                    </button>
                </div>

                <!-- Generated Config -->
                <div class="mt-8">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-bold text-gray-700 uppercase">Generated Configuration</h3>
                        <button onclick="copyConfig()" class="text-blue-600 text-sm hover:underline">Copy to Clipboard</button>
                    </div>
                    <pre id="output-area" class="output-area p-4 rounded-md text-sm min-h-[200px]">Select a device...</pre>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="h-full flex flex-col items-center justify-center text-gray-400">
                <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                <p>Select a device from the left or create a new one.</p>
            </div>
        </main>
    </div>

    <script>
        // --- DATA MODEL ---
        let devices = []; // { id, type, name, interfaces: [], global: {} }
        let activeDeviceId = null;

        // --- HELPERS: IP VALIDATION ---
        function ipToInt(ip) {
            return ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet, 10), 0) >>> 0;
        }

        function maskToInt(mask) {
            return ipToInt(mask);
        }

        function getNetwork(ip, mask) {
            return ipToInt(ip) & ipToInt(mask);
        }

        function validateTopology() {
            const errors = []; // [{ deviceId, interfaceId, message }]

            // 1. Check IP Overlaps within devices
            devices.forEach(dev => {
                const usedRanges = [];
                dev.interfaces.filter(i => i.enabled && i.ip && i.mask).forEach(intf => {
                    const net = getNetwork(intf.ip, intf.mask);
                    // Simple overlap check logic could be complex (ranges).
                    // For now, let's just check exact duplicate IPs as a basic sanity check
                    // Or subnet mismatch is the requested feature.
                });
            });

            // 2. Check Connection Subnet Mismatch
            devices.forEach(dev => {
                dev.interfaces.forEach(intf => {
                    if (intf.connectedTo) { // { deviceId, interfaceId }
                        const remoteDev = devices.find(d => d.id == intf.connectedTo.deviceId);
                        if (remoteDev) {
                            const remoteIntf = remoteDev.interfaces.find(i => i.id == intf.connectedTo.interfaceId);
                            if (remoteIntf && intf.enabled && remoteIntf.enabled && intf.ip && intf.mask && remoteIntf.ip && remoteIntf.mask) {

                                const net1 = getNetwork(intf.ip, intf.mask);
                                const net2 = getNetwork(remoteIntf.ip, remoteIntf.mask);

                                if (net1 !== net2) {
                                    errors.push({
                                        deviceId: dev.id,
                                        interfaceId: intf.id,
                                        message: `Subnet Mismatch! Connected to ${remoteDev.name} (${remoteIntf.ip})`
                                    });
                                }
                            }
                        }
                    }
                });
            });
            return errors;
        }

        // --- APP LOGIC ---

        function init() {
            // Add default router if empty
            if (devices.length === 0) addDevice('router');
        }

        function addDevice(type) {
            const id = Date.now().toString();
            const num = devices.filter(d => d.type === type).length + 1;
            const newDevice = {
                id: id,
                type: type,
                name: `${type.toUpperCase()}-${num}`,
                global: { mpls: false, bgpAs: '' },
                interfaces: [
                    createInterface(1, type),
                    createInterface(2, type)
                ]
            };
            devices.push(newDevice);
            renderDeviceList();
            selectDevice(id);
        }

        function createInterface(id, type) {
            return {
                id: id,
                prefix: "Gi",
                number: `0/${id}`,
                enabled: false,
                ip: "", mask: "",
                mode: type === 'switch' ? 'access' : 'routed',
                vlan: "", trunkVlans: "",
                connectedTo: null // { deviceId, interfaceId }
            };
        }

        function deleteActiveDevice() {
            if (!activeDeviceId) return;
            devices = devices.filter(d => d.id !== activeDeviceId);
            activeDeviceId = null;

            // Clean up connections pointing to this device
            devices.forEach(d => {
                d.interfaces.forEach(i => {
                    if (i.connectedTo && i.connectedTo.deviceId === activeDeviceId) {
                        i.connectedTo = null;
                    }
                });
            });

            renderDeviceList();
            renderConfigPanel();
        }

        function selectDevice(id) {
            activeDeviceId = id;
            renderDeviceList();
            renderConfigPanel();
        }

        function updateHostname(val) {
            const dev = devices.find(d => d.id === activeDeviceId);
            if (dev) {
                dev.name = val;
                renderDeviceList(); // Update name in sidebar
                generateConfig();
            }
        }

        function updateGlobalSetting(key, val) {
            const dev = devices.find(d => d.id === activeDeviceId);
            if (dev) {
                dev.global[key] = val;
                generateConfig();
            }
        }

        function addInterface() {
            const dev = devices.find(d => d.id === activeDeviceId);
            if (!dev) return;
            const newId = dev.interfaces.length > 0 ? Math.max(...dev.interfaces.map(i => i.id)) + 1 : 1;
            dev.interfaces.push(createInterface(newId, dev.type));
            renderConfigPanel();
        }

        function removeInterface(intId) {
            const dev = devices.find(d => d.id === activeDeviceId);
            if (!dev) return;
            dev.interfaces = dev.interfaces.filter(i => i.id !== intId);
            renderConfigPanel();
        }

        function updateInterface(intId, field, value) {
            const dev = devices.find(d => d.id === activeDeviceId);
            if (!dev) return;
            const intf = dev.interfaces.find(i => i.id === intId);
            if (!intf) return;

            intf[field] = value;

            // Re-render only if necessary to avoid focus loss, otherwise just generate config
            if (field === 'mode' || field === 'enabled') {
                renderConfigPanel();
            } else {
                generateConfig();
                // If checking connectivity, trigger validation UI updates
                if (field === 'ip' || field === 'mask') renderValidationErrors();
            }
        }

        function updateConnection(intId, targetString) {
            const dev = devices.find(d => d.id === activeDeviceId);
            const intf = dev.interfaces.find(i => i.id === intId);
            if (!targetString) {
                intf.connectedTo = null;
            } else {
                const [targetDevId, targetIntId] = targetString.split(':');
                intf.connectedTo = { deviceId: targetDevId, interfaceId: parseInt(targetIntId) };

                // Optional: Auto-link the other side? (User requested "connect ports", usually implies bidirectional)
                // Let's do bidirectional linking for convenience
                const remoteDev = devices.find(d => d.id === targetDevId);
                const remoteIntf = remoteDev.interfaces.find(i => i.id == targetIntId);
                if (remoteIntf) {
                    remoteIntf.connectedTo = { deviceId: dev.id, interfaceId: intf.id };
                }
            }
            renderValidationErrors();
        }

        // --- RENDERING ---

        function renderDeviceList() {
            const list = document.getElementById('device-list');
            list.innerHTML = devices.map(d => `
                <div onclick="selectDevice('${d.id}')" class="device-item p-3 border-b border-gray-50 ${d.id === activeDeviceId ? 'active' : ''}">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-bold text-sm text-gray-800">${d.name}</div>
                            <div class="text-xs text-gray-500">${d.type.toUpperCase()}</div>
                        </div>
                        <div class="text-xs bg-gray-200 px-2 py-1 rounded text-gray-600">${d.interfaces.length} IFs</div>
                    </div>
                </div>
            `).join('');
        }

        function renderConfigPanel() {
            const dev = devices.find(d => d.id === activeDeviceId);
            const panel = document.getElementById('config-panel');
            const empty = document.getElementById('empty-state');

            if (!dev) {
                panel.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            panel.classList.remove('hidden');
            empty.classList.add('hidden');

            document.getElementById('active-device-title').innerText = `${dev.type === 'router' ? 'Router' : 'Switch'} Config: ${dev.name}`;
            document.getElementById('dev-hostname').value = dev.name;

            // Global Toggles
            const routerGlobals = document.getElementById('router-globals');
            if (dev.type === 'router') {
                routerGlobals.classList.remove('hidden');
                document.getElementById('dev-mpls').checked = dev.global.mpls || false;
                document.getElementById('dev-bgp-as').value = dev.global.bgpAs || '';
            } else {
                routerGlobals.classList.add('hidden');
            }

            // Interfaces
            const container = document.getElementById('interface-list');
            container.innerHTML = dev.interfaces.map(intf => renderInterfaceCard(dev, intf)).join('');

            generateConfig();
            renderValidationErrors();
        }

        function renderInterfaceCard(dev, intf) {
            // Build Connection Options
            // Filter out self
            const connectionOptions = [`<option value="">-- Disconnected --</option>`];
            devices.filter(d => d.id !== dev.id).forEach(d => {
                d.interfaces.forEach(i => {
                    const selected = intf.connectedTo && intf.connectedTo.deviceId == d.id && intf.connectedTo.interfaceId == i.id ? 'selected' : '';
                    connectionOptions.push(`<option value="${d.id}:${i.id}" ${selected}>${d.name} - ${i.prefix}${i.number}</option>`);
                });
            });

            // Specific Fields based on Type/Mode
            let typeSpecificFields = '';
            if (dev.type === 'router') {
                typeSpecificFields = `
                    <div class="grid grid-cols-2 gap-4 mt-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-500">IP Address</label>
                            <input type="text" value="${intf.ip}" class="w-full p-1.5 rounded enterprise-input text-sm" placeholder="192.168.1.1" onchange="updateInterface(${intf.id}, 'ip', this.value)">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500">Subnet Mask</label>
                            <input type="text" value="${intf.mask}" class="w-full p-1.5 rounded enterprise-input text-sm" placeholder="255.255.255.0" onchange="updateInterface(${intf.id}, 'mask', this.value)">
                        </div>
                    </div>
                `;
            } else {
                // Switch
                typeSpecificFields = `
                    <div class="mt-2">
                        <label class="block text-xs font-medium text-gray-500">Mode</label>
                        <select onchange="updateInterface(${intf.id}, 'mode', this.value)" class="w-full p-1.5 rounded enterprise-input text-sm mb-2">
                            <option value="access" ${intf.mode === 'access' ? 'selected' : ''}>Access</option>
                            <option value="trunk" ${intf.mode === 'trunk' ? 'selected' : ''}>Trunk</option>
                        </select>
                        ${intf.mode === 'access' ? `
                            <label class="block text-xs font-medium text-gray-500">Access VLAN</label>
                            <input type="number" value="${intf.vlan}" class="w-full p-1.5 rounded enterprise-input text-sm" placeholder="10" onchange="updateInterface(${intf.id}, 'vlan', this.value)">
                        ` : `
                            <label class="block text-xs font-medium text-gray-500">Allowed VLANs</label>
                            <input type="text" value="${intf.trunkVlans}" class="w-full p-1.5 rounded enterprise-input text-sm" placeholder="10,20" onchange="updateInterface(${intf.id}, 'trunkVlans', this.value)">
                        `}
                    </div>
                `;
            }

            return `
                <div class="enterprise-card p-4 border-l-4 ${intf.enabled ? 'border-l-green-500' : 'border-l-gray-300'}">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" ${intf.enabled ? 'checked' : ''} onchange="updateInterface(${intf.id}, 'enabled', this.checked)">
                            <div class="flex gap-2">
                                <select onchange="updateInterface(${intf.id}, 'prefix', this.value)" class="p-1 rounded border text-sm">
                                    <option value="Gi" ${intf.prefix==='Gi'?'selected':''}>Gi</option>
                                    <option value="Fa" ${intf.prefix==='Fa'?'selected':''}>Fa</option>
                                    <option value="Te" ${intf.prefix==='Te'?'selected':''}>Te</option>
                                </select>
                                <input type="text" value="${intf.number}" class="w-16 p-1 rounded border text-sm" onchange="updateInterface(${intf.id}, 'number', this.value)">
                            </div>
                        </div>
                        <button onclick="removeInterface(${intf.id})" class="text-gray-400 hover:text-red-500">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>

                    ${typeSpecificFields}

                    <div class="mt-3 pt-3 border-t border-gray-100 bg-gray-50 p-2 rounded">
                        <label class="block text-xs font-bold text-gray-600 mb-1">Topology Connection</label>
                        <select onchange="updateConnection(${intf.id}, this.value)" class="w-full p-1.5 rounded border border-gray-300 text-sm">
                            ${connectionOptions.join('')}
                        </select>
                        <div id="validation-msg-${dev.id}-${intf.id}" class="validation-error"></div>
                    </div>
                </div>
            `;
        }

        function renderValidationErrors() {
            // Clear all first
            document.querySelectorAll('.validation-error').forEach(el => el.innerText = '');

            const errors = validateTopology();
            errors.forEach(err => {
                // err: { deviceId, interfaceId, message }
                const el = document.getElementById(`validation-msg-${err.deviceId}-${err.interfaceId}`);
                if (el) {
                    el.innerText = err.message;
                }
            });
        }

        // --- CONFIG GENERATION ---

        function generateConfig() {
            const dev = devices.find(d => d.id === activeDeviceId);
            const output = document.getElementById('output-area');
            if (!dev) return;

            let config = `hostname ${dev.name}\n!\n`;

            if (dev.type === 'router') {
                if (dev.global.mpls) config += `mpls ip\n`;
                if (dev.global.bgpAs) config += `router bgp ${dev.global.bgpAs}\n bgp log-neighbor-changes\n!\n`;
            }

            dev.interfaces.forEach(intf => {
                if (!intf.enabled) return;

                config += `interface ${intf.prefix}${intf.number}\n`;

                if (dev.type === 'switch') {
                    if (intf.mode === 'access') {
                        config += ` switchport mode access\n`;
                        if (intf.vlan) config += ` switchport access vlan ${intf.vlan}\n`;
                    } else {
                        config += ` switchport trunk encapsulation dot1q\n switchport mode trunk\n`;
                        if (intf.trunkVlans) config += ` switchport trunk allowed vlan ${intf.trunkVlans}\n`;
                    }
                } else {
                    // Router
                    if (intf.ip && intf.mask) config += ` ip address ${intf.ip} ${intf.mask}\n`;
                    if (dev.global.mpls) config += ` mpls ip\n`;
                }

                config += ` no shutdown\n!\n`;
            });

            config += `end`;
            output.textContent = config;
        }

        function copyConfig() {
            const output = document.getElementById('output-area').innerText;
            navigator.clipboard.writeText(output);
            alert("Config copied!");
        }

        // Start
        init();

    </script>
</body>
</html>